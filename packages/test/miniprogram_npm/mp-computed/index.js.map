{"version":3,"sources":["index.js","dep.js","watcher.js"],"names":[],"mappings":";;;;;;;AAAA;AACA;AACA;ACFA,ADGA;ACFA,ADGA;ACFA,ADGA;ACFA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;ADIA,ADGA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA,AENA;AFOA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"index.js","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar dep_1 = require(\"./dep\");\nvar watcher_1 = require(\"./watcher\");\n// change page.data to reactive\nfunction defineReactive(obj, key, val) {\n    var property = Object.getOwnPropertyDescriptor(obj, key);\n    var getter = property && property.get;\n    var setter = property && property.set;\n    var dep = new dep_1.default(key);\n    Object.defineProperty(obj, key, {\n        enumerable: true,\n        configurable: true,\n        get: function () {\n            var value = getter ? getter.call(this) : val;\n            if (dep_1.default.target) {\n                dep.depend();\n            }\n            return value;\n        },\n        set: function (newVal) {\n            var value = getter ? getter.call(this) : val;\n            if (value === newVal) {\n                return;\n            }\n            if (setter) {\n                setter.call(this, newVal);\n            }\n            else {\n                val = newVal;\n            }\n            dep.notify();\n        }\n    });\n    if (['[object Object]', '[object Array]'].indexOf(objToStringCall(val)) >= 0) {\n        Object.keys(val)\n            .forEach(function (subKey) { return defineReactive(obj[key], subKey, obj[key][subKey]); });\n    }\n}\nfunction defineComputed(page, parent, key, userDef) {\n    page.__watchers__ = page.__watchers__ || {};\n    var watcher = page.__watchers__[key] = new watcher_1.default(page, key, userDef);\n    var propertyDefinition = {\n        enumerable: true,\n        configurable: true,\n        set: function () { },\n        get: function () {\n            dep_1.default.target = watcher;\n            if (watcher.dirty) {\n                watcher.evaluate();\n            }\n            dep_1.default.target = null;\n            return watcher.value;\n        }\n    };\n    Object.defineProperty(parent, key, propertyDefinition);\n}\nfunction hookSetData() {\n    var _this = this;\n    var setData = this.setData;\n    this.setData = function (newData, callback) {\n        // 兼容调用 setData 时 key 为路径形式的写法\n        Object.keys(newData)\n            .forEach(function (key) {\n            if (key.indexOf('.') > 0 || key.indexOf('[') > 0) {\n                safeSet(_this.data, key, newData[key]);\n            }\n        });\n        Object.assign(_this.data, newData);\n        // 初始化计算属性，并收集依赖\n        if (_this.__watchers__) {\n            Object.keys(_this.__watchers__)\n                .filter(function (currKey) { return _this.__watchers__[currKey].dirty; })\n                .reduce(function (acc, currKey) {\n                acc[currKey] = _this.data[currKey];\n                return acc;\n            }, newData);\n        }\n        setData.call(_this, newData, callback);\n    };\n    // 调用一次 setData，用于初始化计算属性和依赖收集\n    this.setData({});\n}\nfunction objToStringCall(param) {\n    return Object.prototype.toString.call(param);\n}\nfunction safeSet(obj, props, value) {\n    var propsArr = props\n        .replace(/\\[([^\\[\\]]*)\\]/g, '.$1.')\n        .split('.')\n        .filter(function (key) { return key !== ''; });\n    var lastIdx = propsArr.length - 1;\n    propsArr\n        .reduce(function (prev, curr, idx) {\n        if (idx !== lastIdx) {\n            if (['[object Object]', '[object Array]'].indexOf(objToStringCall(prev[curr])) < 0) {\n                prev[curr] = {};\n            }\n            return prev[curr];\n        }\n        prev[curr] = value;\n    }, obj);\n    return obj;\n}\nfunction createReactive() {\n    var _this = this;\n    if (this.data) {\n        Object.keys(this.data)\n            .forEach(function (key) {\n            if (key !== '__webviewId__') {\n                defineReactive(_this.data, key, _this.data[key]);\n            }\n        });\n        Object.keys(this.computed)\n            .filter(function (key) { return !_this.data.hasOwnProperty(key); })\n            .forEach(function (key) { return defineComputed(_this, _this.data, key, _this.computed[key]); });\n    }\n    hookSetData.call(this);\n}\nexports.createReactive = createReactive;\n","\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar uid = 0;\nvar Dep = /** @class */ (function () {\n    function Dep(key) {\n        this.sub = [];\n        this.uid = ++uid;\n        this.key = key;\n    }\n    Dep.prototype.depend = function () {\n        if (Dep.target) {\n            Dep.target.addDep(this);\n        }\n    };\n    Dep.prototype.addSub = function (watcher) {\n        this.sub.push(watcher);\n    };\n    Dep.prototype.notify = function () {\n        this.sub.forEach(function (watcher) { return watcher.dirty = true; });\n    };\n    return Dep;\n}());\nexports.default = Dep;\n","\"use strict\";\n/// <reference path=\"../libs/page.d.ts\" />\nObject.defineProperty(exports, \"__esModule\", { value: true });\nvar Watcher = /** @class */ (function () {\n    function Watcher(page, key, getter) {\n        this.dirty = true;\n        this.depIds = new Set();\n        this.deps = [];\n        this.page = page;\n        this.key = key;\n        this.getter = getter;\n    }\n    Watcher.prototype.evaluate = function () {\n        if (this.dirty) {\n            this.dirty = false;\n            this.value = this.getter.call(this.page);\n            return this.value;\n        }\n    };\n    Watcher.prototype.addDep = function (dep) {\n        var uid = dep.uid;\n        if (!this.depIds.has(uid)) {\n            this.depIds.add(uid);\n            this.deps.push(dep);\n            dep.addSub(this);\n        }\n    };\n    return Watcher;\n}());\nexports.default = Watcher;\n;\n"]}